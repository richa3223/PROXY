# Redact sensitive data

Redacts the "sensitive" block from the standard event structure for any event that gets ingested into the reporting audit store.
As firehose batches together events to be redacted into a "records" array, the lambda can handle multiple records from firehose at once.

## Configuration

The following settings are required for the lambda to run.

| Setting name | Purpose                       |
| ------------ | ----------------------------- |
|              | No specific settings required |

## Parameters

The lambda requires inputs generated by AWS Firehose

| Parameter name              | Data type      | Purpose                                                           |
| --------------------------- | -------------- | ----------------------------------------------------------------- |
| records                     | json           | List of records that are passed from firehose to lambda           |
| recordId                    | json           | Record id generated by firehose.                                  |
| approximateArrivalTimestamp | unix timestamp | approximate time that firehose received the event                 |
| data                        | base64 string  | base64 encoded data representing an event pushed on the event bus |



## Outputs

The lambda is expected to return the following

| Output path | Data type     | Purpose                                                          |
| ----------- | ------------- | ---------------------------------------------------------------- |
| Records     | json          | List of transformed records                                      |
| recordId    | json          | Record id generated by firehose.                                 |
| result      | str           | Result of transformation, can be ProcessingFailed, Dropped or OK |
| data        | base64 string | Transformed data                                                 |

## Local Testing

The following is a code sample of a python script that will publish an event that can be processed by the lambda downstream.

```python
from datetime import datetime
import uuid
from lambdas.utils.code_bindings.validation_result import Event as ValidationResult
from lambdas.utils.code_bindings.validation_result import (
    Detail,
    Detail_metadata,
    Detail_sensitive,
    Detail_standard,
)
import boto3
from lambdas.utils.event_utilities.event_publisher import ValidationResultEventPublisher

class PublishEvent():
    def publish_dummy_event(self):
        publisher = ValidationResultEventPublisher()
        dummy_event = self.populate_dummy_validation_result_event()
        return publisher.publish(dummy_event)

    @staticmethod
    def populate_dummy_validation_result_event():
        dummy_result = ValidationResult()
        dummy_result.DetailType = "Validation Successful"
        dummy_result.EventBusName = "main-event-bus"
        dummy_result.Source = "Validation Service"

        dummy_detail_metadata = Detail_metadata()
        dummy_detail_metadata.request_id = str(uuid.uuid4())
        dummy_detail_metadata.created = datetime.now()
        dummy_detail_metadata.correlation_id = str(uuid.uuid4())
        dummy_detail_metadata.client_key = str(uuid.uuid4())

        dummy_detail_sensitive = Detail_sensitive()
        dummy_detail_sensitive.patient_identifier = "9435797881"
        dummy_detail_sensitive.proxy_identifier = "9435775039"

        dummy_detail_standard = Detail_standard()
        dummy_detail_standard.proxy_identifier_type = "NHS Number"
        dummy_detail_standard.relationship_type = "GESTM"
        dummy_detail_standard.validation_result_info = {
            "VALIDATED_RELATIONSHIP": "Validated relationship"
        }

        dummy_detail = Detail(
            dummy_detail_metadata, dummy_detail_sensitive, dummy_detail_standard
        )
        dummy_result.Detail = dummy_detail
        return dummy_result


generate_event = PublishEvent()
generate_event.publish_dummy_event()

```
Once an event is published and consumed by the audit store, running the following querry in Athena (against reporting store) should return the redacted event:

```
select * from "npa-1612-queryable-data-catalogue"."audit_npa_1612_dev_queryable_audit_events_bucket" where detail."sensitive" = '[REDACTED]' and detail.metadata."correlation-id" = 'be7581e0-6266-4d74-b74e-03f1927f89a7'

```

## Deployment

This lambda function is deployed to AWS using Terraform CI / CD pipeline.
